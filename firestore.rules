rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // --- HELPER FUNCTIONS ---

    // 1. Check if user is logged in
    function isAuthenticated() {
      return request.auth != null;
    }

    // 2. Get the User's Role
    function getUserRole() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role;
    }

    // 3. Check if user is Management 
    // FIXED: Added 'Site Supervisor' to match your database data
    function isManagement() {
      return getUserRole() in ['Admin', 'Superadmin', 'Supervisor', 'Site Supervisor'];
    }

    // --- SIMPLE COLLECTIONS ---

    match /equipment/{equipmentId} {
      allow read: if isAuthenticated();
      allow write: if isManagement() || getUserRole() == 'Technician';
    }

    match /vsds/{vsdId} {
      allow read: if isAuthenticated();
      allow write: if isManagement() || getUserRole() == 'Technician';
    }

    match /completed_schedules/{scheduleId} {
      allow read: if isAuthenticated();
      allow write: if isManagement() || getUserRole() == 'Technician';
    }

    match /equipment/{equipmentId}/performance_records/{recordId} {
      allow read: if isAuthenticated();
      allow write: if isManagement() || getUserRole() == 'Technician';
    }

    // --- OPEN COLLECTIONS ---
    
    match /breakdown_reports/{reportId} {
      allow read, write: if isAuthenticated();
    }

    match /tasks/{taskId} {
      allow read, write: if isAuthenticated();
    }

    // --- COMPLEX COLLECTIONS ---

    // 1. USERS COLLECTION
    match /users/{userId} {
      allow read: if request.auth.uid == userId || isManagement();
      allow write: if isManagement();
    }

    // 2. DAILY DIARIES (The Workflow Logic)
    match /daily_diaries/{diaryId} {
      // VIEW: Everyone can see all diaries
      allow read, list: if isAuthenticated();
      
      // CREATE: User can create, but MUST stamp it with their own ID
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      
      // UPDATE: The "Lock" Logic
      // Works even if 'isSignedOff' is missing (defaults to allowed)
      allow update: if isAuthenticated() && (
          (resource.data.userId == request.auth.uid && resource.data.isSignedOff != true)
          ||
          isManagement()
      );

      // DELETE: Only Management can delete
      allow delete: if isManagement();
    }

    // 3. TIMESHEETS
    match /timesheets/{timesheetId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow update, delete: if isAuthenticated() && (
          resource.data.userId == request.auth.uid || isManagement()
      );
    }
  }
}