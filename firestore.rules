rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // --- HELPER FUNCTIONS (To keep code clean) ---

    // 1. Check if user is logged in
    function isAuthenticated() {
      return request.auth != null;
    }

    // 2. Get the User's Role from the 'users' collection
    function getUserRole() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role;
    }

    // 3. Check if the user is Management (Admin, Superadmin, or Supervisor)
    function isManagement() {
      return getUserRole() in ['Admin', 'Superadmin', 'Supervisor'];
    }

    // --- SIMPLE COLLECTIONS ---
    // Read: All Users | Write: Management Only

    match /equipment/{equipmentId} {
      allow read: if isAuthenticated();
      allow write: if isManagement() || getUserRole() == 'Technician';
    }

    match /vsds/{vsdId} {
      allow read: if isAuthenticated();
      allow write: if isManagement() || getUserRole() == 'Technician';
    }

    match /completed_schedules/{scheduleId} {
      allow read: if isAuthenticated();
      allow write: if isManagement() || getUserRole() == 'Technician';
    }

    match /equipment/{equipmentId}/performance_records/{recordId} {
      allow read: if isAuthenticated();
      allow write: if isManagement() || getUserRole() == 'Technician';
    }

    // --- OPEN COLLECTIONS ---
    
    match /breakdown_reports/{reportId} {
      allow read, write: if isAuthenticated();
    }

    match /tasks/{taskId} {
      allow read, write: if isAuthenticated();
    }

    // --- COMPLEX COLLECTIONS ---

    // 1. USERS COLLECTION
    match /users/{userId} {
      // Users can read their own profile. Management can read/write all profiles.
      allow read: if request.auth.uid == userId || isManagement();
      allow write: if isManagement();
    }

    // 2. DAILY DIARIES (The Workflow Logic)
    match /daily_diaries/{diaryId} {
      // VIEW: Everyone can see all diaries
      allow read, list: if isAuthenticated();
      
      // CREATE: User can create, but MUST stamp it with their own ID
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      
      // UPDATE: The "Lock" Logic
      allow update: if isAuthenticated() && (
          // Option A: The Owner is editing, AND it is NOT signed off yet
          (resource.data.userId == request.auth.uid && resource.data.isSignedOff != true)
          ||
          // Option B: A Supervisor/Admin is editing (to sign it off or fix mistakes)
          isManagement()
      );

      // DELETE: Only Management can delete (Prevents users from hiding evidence)
      allow delete: if isManagement();
    }

    // 3. TIMESHEETS (Fixed)
    match /timesheets/{timesheetId} {
      allow read: if isAuthenticated();
      
      // Create: User must own the new document
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      
      // Update/Delete: User must own the existing document OR be management
      allow update, delete: if isAuthenticated() && (
          resource.data.userId == request.auth.uid || isManagement()
      );
    }
  }
}
